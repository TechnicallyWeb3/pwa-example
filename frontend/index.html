<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="AI Assistant Chat PWA">
  <meta name="theme-color" content="#2196F3">
  <title>AI Assistant</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" type="image/png" href="/icon-192x192.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      color: #333;
      overflow: hidden;
    }

    .app-container {
      display: none;
      height: 100vh;
      width: 100%;
      background: white;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    .app-container.active {
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: #f9f9f9;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-header h3 {
      font-size: 18px;
      color: #333;
    }

    .btn-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      color: #2196F3;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .btn-icon:hover {
      background: #e3f2fd;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .chat-item {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
      border: 1px solid transparent;
    }

    .chat-item:hover {
      background: #f0f0f0;
    }

    .chat-item.active {
      background: #e3f2fd;
      border-color: #2196F3;
    }

    .chat-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chat-meta {
      font-size: 12px;
      color: #666;
    }

    .empty-state {
      padding: 20px;
      text-align: center;
      color: #999;
      font-size: 14px;
    }

    /* Main Chat Area */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      background: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header h2 {
      font-size: 20px;
      color: #333;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #fafafa;
      display: flex;
      flex-direction: column;
    }

    .message {
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      max-width: 70%;
    }

    .message.user {
      align-self: flex-end;
      align-items: flex-end;
    }

    .message.assistant {
      align-self: flex-start;
      align-items: flex-start;
    }

    .message-content {
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      line-height: 1.4;
    }

    .message.user .message-content {
      background: #e0e0e0;
      color: #333;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
      background: #2196F3;
      color: white;
      border-bottom-left-radius: 4px;
    }

    /* Markdown styling */
    .message-content h1,
    .message-content h2,
    .message-content h3 {
      margin: 12px 0 8px 0;
      font-weight: 600;
    }

    .message-content h1 {
      font-size: 1.5em;
    }

    .message-content h2 {
      font-size: 1.3em;
    }

    .message-content h3 {
      font-size: 1.1em;
    }

    .message-content p {
      margin: 8px 0;
    }

    .message-content code {
      background: rgba(0, 0, 0, 0.05);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .message-content pre {
      background: rgba(0, 0, 0, 0.05);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
    }

    .message-content pre code {
      background: none;
      padding: 0;
    }

    .message-content ul,
    .message-content ol {
      margin: 8px 0;
      padding-left: 24px;
    }

    .message-content li {
      margin: 4px 0;
    }

    .message-content a {
      color: #2196F3;
      text-decoration: underline;
    }

    .message-content a:hover {
      color: #1976D2;
    }

    .message-content strong {
      font-weight: 600;
    }

    .message-content em {
      font-style: italic;
    }

    /* Typing indicator */
    .typing-indicator .message-content {
      background: white;
      border: 1px solid #e0e0e0;
      padding: 12px 20px;
    }

    .typing-dots {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .typing-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #999;
      animation: typing 1.4s infinite;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        opacity: 0.3;
        transform: translateY(0);
      }
      30% {
        opacity: 1;
        transform: translateY(-4px);
      }
    }

    .message-time {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
      padding: 0 4px;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      justify-content: flex-end;
    }

    .message.user .message-header {
      justify-content: flex-end;
    }

    .message.assistant .message-header {
      justify-content: flex-start;
    }

    .message-edit-btn {
      background: rgba(0, 0, 0, 0.1);
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .message:hover .message-edit-btn {
      opacity: 1;
    }

    .message-edit-btn:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    .branch-status {
      font-size: 11px;
      color: #666;
      background: rgba(0, 0, 0, 0.05);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .branch-navigation {
      display: flex;
      gap: 4px;
      margin-top: 8px;
      padding: 4px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 8px;
      flex-wrap: wrap;
    }

    .branch-nav-btn {
      background: rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 11px;
      min-width: 24px;
      text-align: center;
      transition: all 0.2s;
    }

    .branch-nav-btn:hover {
      background: rgba(0, 0, 0, 0.15);
    }

    .branch-nav-btn.active {
      background: #2196F3;
      color: white;
      border-color: #2196F3;
    }

    .empty-chat {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
      text-align: center;
    }

    .empty-chat h3 {
      margin-bottom: 8px;
      color: #666;
    }

    .chat-input-container {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      background: white;
    }

    .chat-form {
      display: flex;
      gap: 12px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 24px;
      font-size: 15px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }

    .chat-input:focus {
      border-color: #2196F3;
    }

    .send-btn {
      padding: 12px 24px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 24px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .send-btn:hover {
      background: #1976D2;
    }

    .send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Auth Section */
    .auth-section {
      display: none;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      align-items: center;
      justify-content: center;
    }

    .auth-section.active {
      display: flex;
    }

    .auth-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .auth-container h2 {
      text-align: center;
      margin-bottom: 10px;
      color: #333;
    }

    .auth-container p {
      text-align: center;
      margin-bottom: 30px;
      color: #666;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #f44336;
    }

    .hidden {
      display: none !important;
    }

    .install-prompt {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }

    .install-prompt button {
      margin-top: 10px;
      background: #ffc107;
      color: #333;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Debug styles */
    .debug-section {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .debug-item {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .debug-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .debug-item strong {
      display: block;
      margin-bottom: 5px;
      color: #555;
    }

    .debug-item code {
      display: block;
      background: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      word-break: break-all;
      color: #2196F3;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        position: absolute;
        z-index: 100;
        height: 100%;
        transform: translateX(-100%);
        transition: transform 0.3s;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .message {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>
  <!-- Install Prompt -->
  <div id="installPrompt" class="install-prompt hidden" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; max-width: 400px;">
    <p>Install this app for a better experience!</p>
    <button id="installBtn">Install App</button>
  </div>

  <!-- Auth Section -->
  <div id="authSection" class="auth-section active">
    <div class="auth-container">
      <h2>Welcome</h2>
      <p>Sign in with Google to continue</p>
      <div id="authError" class="error hidden"></div>
      <button id="googleSignInBtn" class="btn btn-primary">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        Sign in with Google
      </button>
    </div>
  </div>

  <!-- Main App -->
  <div id="appSection" class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Chats</h3>
        <button class="btn-icon" onclick="createNewChat()" title="New Chat">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </button>
      </div>
      <div id="chatSidebar" class="chat-list">
        <div class="empty-state">Loading chats...</div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main">
      <div class="chat-header">
        <h2>AI Assistant</h2>
        <button class="btn-icon" onclick="logout()" title="Logout">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </button>
      </div>
      <div id="messagesContainer" class="messages-container">
        <div class="empty-chat">
          <h3>Start a conversation</h3>
          <p>Send a message to begin chatting with the AI assistant.</p>
        </div>
      </div>
      <div class="chat-input-container">
        <form id="chatForm" class="chat-form">
          <input 
            type="text" 
            id="messageInput" 
            class="chat-input" 
            placeholder="Type a message..." 
            autocomplete="off"
          />
          <button type="submit" class="send-btn">Send</button>
        </form>
      </div>
    </div>
  </div>

  <script type="module" src="/main.ts"></script>
</body>
</html>
